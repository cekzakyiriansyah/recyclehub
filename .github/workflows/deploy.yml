name: Deploy to VPS
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /home/ubuntu/recyclehub
          
          git pull origin main
          sudo docker build -t recyclehub .
          sudo docker stop recyclehub || true
          sudo docker rm recyclehub || true
          
          # PAKAI PORT 3001 (beda dari Grafana di 3000)
          sudo docker run -d --name recyclehub -p 3001:3000 recyclehub
          
          # Cek status
          sudo docker ps
          echo "‚úÖ RecycleHub deployed on port 3001!"
          echo "üåê Access via: http://157.10.160.57:3001"
